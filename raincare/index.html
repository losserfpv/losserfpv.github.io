<html>
    <head>
        <title>Rain Care</title>
        <script>
            var characteristics;
            var decoder = new TextDecoder("utf-8");
            var encoder = new TextEncoder("utf-8");
            
            async function onStartButtonClick() {
                clearConsole();
                
                let serviceUuid = '0b61456e-82f4-4c39-b1ec-fc81cae37135';

                let characteristicUuid_SSID = 'f1f5856d-35e1-4cbb-8c3e-77d31d50f3bb';
                let characteristicUuid_PASS = '01549472-73bf-4a37-9bb0-32ab78d028f8';

                log('Requesting Bluetooth Device...');

                try {
                    log('Requesting Bluetooth Device...');
                    const device = await navigator.bluetooth.requestDevice(
                        {filters: [{name: "RainCare BLE"}], optionalServices: [serviceUuid]});

                    log('Connecting to GATT Server...');
                    const server = await device.gatt.connect();

                    log('Getting Service...');
                    const service = await server.getPrimaryService(serviceUuid);

                    log('Getting Characteristics...');
                      
                    characteristics = await service.getCharacteristics();
                    log("Size: " + characteristics.length);
                    
                    for(i=0; i<characteristics.length; i++)
                    {
                        let value = await characteristics[i].readValue();
                        value = decoder.decode(value);
                        log("UUID: " + characteristics[i].uuid);
                        
                        let elementID;
                        if(characteristics[i].uuid == characteristicUuid_SSID)
                        {
                            elementID = "ssid";
                        }
                        else if(characteristics[i].uuid == characteristicUuid_PASS)
                        {
                            elementID = "pass";
                        }
                        log("New: " + value);
                        let ssid = document.getElementById(elementID);
                        ssid.value = value;
                    }
                    
                } catch(error) {
                    log('Argh! ' + error);
                }
                
                
                
            }
            
            async function onSave()
            {
                for(i=0; i<characteristics.length; i++)
                {
                    characteristics[i].writeValue(encoder.encode("write " + i));
                    log("wrote index " + i;);
                }
            }

            function log(stringvalue)
            {
                let output = document.querySelector('.output');
                output.innerHTML += "<br>" + stringvalue;
            }
            
            function clearConsole()
            {
                let output = document.querySelector('.output');
                output.innerHTML = "";
            }                
            
        </script>
    </head>
    <body>
        <h1>Welcome to the Rain Care Configurator</h>
        <br>
        <button onclick="onStartButtonClick()" style="width: 100px; height: 50px;">Connect</button>
        <button onclick="onSave()" style="width: 100px; height: 50px;">Save</button>
        <table>
            <tr>
                <td>WiFi SSID:</td><td><input type="text" id="ssid" /></td>
            </tr>
            <tr>
                <td>WiFi Password:</td><td><input type="text" id="pass" /></td>
            </tr>
        </table>
        <div class="output"></div>
    </body>
</html>
