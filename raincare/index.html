<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="style.css">
        <title>Rain Care</title>
        <script>
            var serviceUuid = '0b61456e-82f4-4c39-b1ec-fc81cae37135';
            var characteristicUuid_SSID = 'f1f5856d-35e1-4cbb-8c3e-77d31d50f3bb';
            var characteristicUuid_PASS = '01549472-73bf-4a37-9bb0-32ab78d028f8';
            var characteristics;
            var decoder = new TextDecoder("utf-8");
            var encoder = new TextEncoder("utf-8");
            
            async function onConnect() {
                clearConsole();

                try {
                     const device = await navigator.bluetooth.requestDevice(
                        {filters: [{name: "RainCare BLE"}], optionalServices: [serviceUuid]});

                    const server = await device.gatt.connect();

                    const service = await server.getPrimaryService(serviceUuid);
                      
                    characteristics = await service.getCharacteristics();
                    
                    for(i=0; i<characteristics.length; i++)
                    {
                        let value = await characteristics[i].readValue();
                        value = decoder.decode(value);
                        
                        let elementID;
                        if(characteristics[i].uuid == characteristicUuid_SSID)
                        {
                            elementID = "ssid";
                        }
                        else if(characteristics[i].uuid == characteristicUuid_PASS)
                        {
                            elementID = "pass";
                        }
                        let textField = document.getElementById(elementID);
                        textField.value = value;
                        
                        let table = document.getElementById("table");
                        table.style.display = "initial";
                        
                        let btnSave = document.getElementById("btnSave");
                        btnSave.style.display = "initial";
                        
                        let btnConnect = document.getElementById("btnConnect");
                        btnConnect.style.display = "none";
                   }
                    
                } catch(error) {
                    log('Argh! ' + error);
                }
            }
            
            async function onSave()
            {
                for(i=0; i<characteristics.length; i++)
                {
                    if(characteristics[i].uuid == characteristicUuid_SSID)
                    {
                        elementID = "ssid";
                    }
                    else if(characteristics[i].uuid == characteristicUuid_PASS)
                    {
                        elementID = "pass";
                    }
                    let textField = document.getElementById(elementID);
                    await characteristics[i].writeValue(encoder.encode(textField.value));
                }
            }

            function log(stringvalue)
            {
                let output = document.querySelector('.output');
                output.innerHTML += "<br>" + stringvalue;
            }
            
            function clearConsole()
            {
                let output = document.querySelector('.output');
                output.innerHTML = "";
            }                
            
        </script>
    </head>
    <body>
        <h1>Welcome to the Rain Care Configurator</h>
        <br>
        <button id="btnConnect" onclick="onConnect()" style="width: 100px; height: 50px;">Connect</button>
        <button id="btnSave" onclick="onSave()" style="width: 100px; height: 50px; display: none;">Save</button>
        <br>
        <table id="table" style="display: none;">
            <tr>
                <td>WiFi SSID:</td><td><input type="text" id="ssid" /></td>
            </tr>
            <tr>
                <td>WiFi Password:</td><td><input type="text" id="pass" /></td>
            </tr>
        </table>
        <div class="output"></div>
        <img src="bluetooth.gif" style="display: block; margin-left: auto; margin-right: auto; width: 40%; max-width: 200px;"></img>
    </body>
</html>
